<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Clash Royale Web - PvP</title>
    <style>
        /* --- Í∏∞Î≥∏ ÏÑ§Ï†ï Î∞è Ìè∞Ìä∏ --- */
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700;900&display=swap');

        :root {
            --primary-blue: #366bf7;
            --primary-gold: #fccf44;
            --text-stroke: #000;
            --bg-dark: #1c2b45;
            --arena-grass: #4c9635;
            --hp-green: #68cc1e;
            --hp-red: #d11e1e;
        }

        * {
            box-sizing: border-box;
            user-select: none;
            touch-action: manipulation;
        }

        body {
            margin: 0;
            padding: 0;
            font-family: 'Noto Sans KR', sans-serif;
            background-color: #000;
            color: white;
            overflow: hidden;
            width: 100vw;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        #app-container {
            width: 100%;
            height: 100%;
            max-width: 500px;
            background-color: var(--bg-dark);
            position: relative;
            overflow: hidden;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
        }

        /* --- Í≥µÌÜµ UI ÏöîÏÜå --- */
        .hidden { display: none !important; }
        
        .btn {
            border: 2px solid #000;
            border-radius: 10px;
            padding: 12px 24px;
            font-weight: 900;
            font-size: 1.2rem;
            cursor: pointer;
            box-shadow: 0 4px 0 #000;
            transition: transform 0.1s, box-shadow 0.1s;
            text-align: center;
        }
        .btn:active {
            transform: translateY(4px);
            box-shadow: 0 0 0 #000;
        }
        .btn-gold {
            background: linear-gradient(to bottom, #ffea00, #ffbb00);
            color: #4a2c0f;
            text-shadow: 0 1px 0 rgba(255,255,255,0.4);
            border-color: #8c6400;
        }
        .btn-red {
            background-color: #e74c3c;
            color: white;
            border-color: #922b21;
        }
        .btn-google {
            background-color: white;
            color: #555;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            font-size: 1rem;
            border-color: #ccc;
        }

        /* --- 1. Î°úÍ∑∏Ïù∏ ÌôîÎ©¥ --- */
        #login-screen {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background: linear-gradient(135deg, #2b5876 0%, #4e4376 100%);
        }
        .logo {
            font-size: 3rem;
            font-weight: 900;
            color: var(--primary-gold);
            text-shadow: 3px 3px 0 #000, 0 0 20px rgba(255, 215, 0, 0.5);
            margin-bottom: 50px;
            text-align: center;
            line-height: 1.2;
        }
        #loading-msg {
            margin-top: 20px;
            font-size: 0.9rem;
            color: #ccc;
        }

        /* --- 2. Ìôà ÌôîÎ©¥ --- */
        #home-screen {
            width: 100%;
            height: 100%;
            background: radial-gradient(circle at center, #2c3e50, #000);
            position: relative;
        }

        /* ÏÉÅÎã® ÌîÑÎ°úÌïÑ Î∞î */
        .top-bar {
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            z-index: 10;
        }

        .profile-container {
            position: relative;
        }

        .nickname-box {
            background: rgba(0,0,0,0.6);
            padding: 8px 15px;
            border-radius: 20px;
            border: 2px solid #555;
            cursor: pointer;
            display: flex;
            flex-direction: column;
        }
        .nickname-text {
            font-weight: bold;
            font-size: 1.1rem;
            color: #fff;
        }
        .exp-bar {
            height: 4px;
            background: #366bf7;
            width: 100%;
            margin-top: 4px;
            border-radius: 2px;
        }

        /* ÎìúÎ°≠Îã§Ïö¥ Î©îÎâ¥ */
        #profile-dropdown {
            position: absolute;
            top: 55px;
            left: 0;
            background: #333;
            border: 2px solid #000;
            border-radius: 8px;
            width: 160px;
            z-index: 100;
            padding: 5px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5);
        }
        .dropdown-item {
            padding: 10px;
            border-bottom: 1px solid #444;
            cursor: pointer;
            font-size: 0.9rem;
            text-align: center;
        }
        .dropdown-item:last-child { border-bottom: none; }
        .text-white { color: white; }
        .text-red { color: #ff5e5e; font-weight: bold; }

        /* Ìä∏Î°úÌîº */
        .trophy-display {
            background: rgba(0,0,0,0.5);
            padding: 8px 15px;
            border-radius: 20px;
            display: flex;
            align-items: center;
            gap: 5px;
            color: var(--primary-gold);
            font-weight: 900;
            font-size: 1.2rem;
            border: 2px solid #8e6e22;
        }

        /* Ï∫êÎ¶≠ÌÑ∞ ÌëúÏãú (Ïû•Ïãù) */
        .home-character {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -60%);
            font-size: 8rem;
            filter: drop-shadow(0 10px 10px rgba(0,0,0,0.5));
            animation: float 3s ease-in-out infinite;
        }
        @keyframes float { 0%, 100% { transform: translate(-50%, -60%); } 50% { transform: translate(-50%, -65%); } }

        /* ÌïòÎã® Ï†ÑÌà¨ Î≤ÑÌäº */
        .bottom-bar {
            position: absolute;
            bottom: 30px;
            width: 100%;
            display: flex;
            justify-content: center;
        }
        #battle-btn {
            font-size: 1.5rem;
            padding: 15px 50px;
            border-radius: 30px;
            text-transform: uppercase;
        }

        /* --- 3. Îß§Ïπ≠ ÌôîÎ©¥ --- */
        #matching-screen {
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.85);
            position: absolute;
            top: 0;
            left: 0;
            z-index: 50;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        .searching-text {
            font-size: 1.5rem;
            margin-bottom: 20px;
            animation: pulse 1s infinite;
        }
        @keyframes pulse { 0% { opacity: 0.6; } 50% { opacity: 1; } 100% { opacity: 0.6; } }

        /* --- 4. Í≤åÏûÑ ÌôîÎ©¥ (ÏïÑÎ†àÎÇò) --- */
        #game-screen {
            width: 100%;
            height: 100%;
            background-color: var(--arena-grass);
            position: relative;
            display: flex;
            flex-direction: column;
        }

        /* ÏïÑÎ†àÎÇò Îßµ */
        #arena {
            flex: 1;
            position: relative;
            /* Ï≤¥ÌÅ¨Î¨¥Îä¨ ÏûîÎîî Ìå®ÌÑ¥ */
            background-image: 
                linear-gradient(45deg, #448930 25%, transparent 25%, transparent 75%, #448930 75%, #448930),
                linear-gradient(45deg, #448930 25%, transparent 25%, transparent 75%, #448930 75%, #448930);
            background-position: 0 0, 20px 20px;
            background-size: 40px 40px;
            background-color: #4c9635;
            overflow: hidden;
            box-shadow: inset 0 0 50px rgba(0,0,0,0.5);
        }

        /* Í∞ï */
        .river {
            position: absolute;
            top: 50%;
            left: 0;
            width: 100%;
            height: 40px;
            background: #4a90e2;
            transform: translateY(-50%);
            border-top: 3px solid #8e6e22;
            border-bottom: 3px solid #8e6e22;
            z-index: 1;
            background-image: url("data:image/svg+xml,%3Csvg width='20' height='20' viewBox='0 0 20 20' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M0 10 Q5 5 10 10 T20 10' stroke='rgba(255,255,255,0.3)' fill='none'/%3E%3C/svg%3E");
            animation: flow 2s linear infinite;
        }
        @keyframes flow { from { background-position: 0 0; } to { background-position: 20px 0; } }

        /* Îã§Î¶¨ */
        .bridge {
            position: absolute;
            width: 50px;
            height: 60px;
            background: url("data:image/svg+xml,%3Csvg width='10' height='10' viewBox='0 0 10 10' xmlns='http://www.w3.org/2000/svg'%3E%3Crect width='10' height='2' fill='%233e2723'/%3E%3C/svg%3E") #8d6e63;
            top: 50%;
            transform: translateY(-50%);
            z-index: 2;
            border-left: 3px solid #3e2723;
            border-right: 3px solid #3e2723;
            box-shadow: 0 5px 10px rgba(0,0,0,0.3);
        }
        .bridge.left { left: 20%; }
        .bridge.right { right: 20%; }

        /* ÌÉÄÏõå Í≥µÌÜµ */
        .tower {
            position: absolute;
            width: 50px;
            height: 50px;
            display: flex;
            flex-direction: column;
            align-items: center;
            z-index: 5;
            font-size: 2rem;
            /* ÌÉÄÏõå Î∞îÎã•ÏûêÍµ≠ */
            filter: drop-shadow(0 5px 5px rgba(0,0,0,0.6));
        }
        
        /* ÌÉÄÏõå HP Î∞î Í∞úÏÑ† */
        .hp-bar-container {
            width: 60px;
            height: 14px;
            background: #222;
            margin-bottom: 5px;
            border: 2px solid #000;
            border-radius: 4px;
            position: relative;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .hp-bar { 
            height: 100%; 
            background: linear-gradient(to bottom, #7ce82b, #4cae0b); 
            width: 100%; 
            transition: width 0.2s; 
            position: absolute;
            left: 0;
            top: 0;
            z-index: 1;
        }
        .tower.enemy .hp-bar { 
            background: linear-gradient(to bottom, #ff5e5e, #c0392b); 
        }
        .hp-text {
            position: relative;
            z-index: 2;
            font-size: 0.6rem;
            color: white;
            font-weight: bold;
            text-shadow: 1px 1px 0 #000;
        }

        /* ÌÉÄÏõå ÏúÑÏπò */
        .king-tower { left: 50%; transform: translateX(-50%); width: 70px; height: 70px; font-size: 3rem;}
        .princess-tower { width: 50px; height: 50px; }
        
        /* ÏïÑÍµ∞ ÌÉÄÏõå (ÏïÑÎûò) */
        .my-king { bottom: 100px; }
        .my-princess.left { bottom: 180px; left: 15%; }
        .my-princess.right { bottom: 180px; right: 15%; }

        /* Ï†ÅÍµ∞ ÌÉÄÏõå (ÏúÑ) */
        .enemy-king { top: 80px; }
        .enemy-princess.left { top: 160px; left: 15%; }
        .enemy-princess.right { top: 160px; right: 15%; }

        /* Ïú†Îãõ (Entity) */
        .unit {
            position: absolute;
            width: 40px;
            height: 40px;
            font-size: 1.8rem;
            display: flex;
            justify-content: center;
            align-items: center;
            transform: translate(-50%, -50%);
            transition: top 0.1s linear, left 0.1s linear;
            z-index: 10;
        }
        .unit.enemy { filter: hue-rotate(180deg) brightness(0.9); }
        .unit-hp {
            position: absolute;
            top: -8px;
            width: 30px;
            height: 5px;
            background: #333;
            border: 1px solid black;
        }
        .unit-hp-fill { background: #4cae0b; height: 100%; width: 100%; }
        .unit.enemy .unit-hp-fill { background: #e74c3c; }

        /* Ìà¨ÏÇ¨Ï≤¥ */
        .projectile {
            position: absolute;
            width: 12px;
            height: 12px;
            background: radial-gradient(circle, #ffaa00, #ff5500);
            border-radius: 50%;
            z-index: 20;
            pointer-events: none;
            box-shadow: 0 0 5px #ffaa00;
        }

        /* ÌïòÎã® Ïπ¥Îìú Îç± UI */
        #game-ui {
            height: 140px;
            background: #5d4037;
            border-top: 4px solid #3e2723;
            display: flex;
            align-items: center;
            padding: 0 10px;
            position: relative;
            box-shadow: 0 -5px 15px rgba(0,0,0,0.5);
        }

        .elixir-bar {
            position: absolute;
            top: -15px;
            left: 0;
            width: 100%;
            height: 15px;
            background: #222;
            border-top: 2px solid #000;
        }
        .elixir-fill {
            height: 100%;
            background: linear-gradient(to bottom, #d55eff, #a800e0);
            width: 0%;
            transition: width 0.1s linear;
            box-shadow: 0 0 10px #d000ff;
        }
        .elixir-count {
            position: absolute;
            top: -40px;
            right: 10px;
            color: #d000ff;
            font-weight: 900;
            font-size: 2rem;
            text-shadow: 2px 2px 0 #000;
        }

        .next-card {
            width: 50px;
            height: 70px;
            background: #333;
            border-radius: 5px;
            margin-right: 15px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            color: #aaa;
            border: 2px solid #111;
        }
        .next-card-icon { font-size: 1.5rem; }

        .hand {
            flex: 1;
            display: flex;
            justify-content: space-around;
            gap: 5px;
        }

        .card {
            width: 70px;
            height: 90px;
            background: linear-gradient(135deg, #fff, #ddd);
            border: 2px solid #555;
            border-radius: 8px;
            position: relative;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 2px;
            transition: transform 0.1s, border-color 0.1s;
            box-shadow: 0 3px 5px rgba(0,0,0,0.5);
        }
        .card.selected {
            border: 4px solid var(--primary-gold);
            transform: translateY(-15px) scale(1.05);
            box-shadow: 0 0 15px var(--primary-gold);
            z-index: 20;
        }
        .card.disabled {
            filter: grayscale(1) brightness(0.6);
            cursor: not-allowed;
        }
        .card-img { font-size: 2.5rem; margin-top: 5px; }
        .card-cost {
            position: absolute;
            top: -8px;
            left: -8px;
            background: #d000ff;
            color: white;
            border: 2px solid #000;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: bold;
            font-size: 0.9rem;
            box-shadow: 0 2px 3px rgba(0,0,0,0.5);
        }

        /* Í≤∞Í≥º Î™®Îã¨ */
        #result-modal {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 100;
            display: none;
            backdrop-filter: blur(5px);
        }
        .result-title { font-size: 3rem; font-weight: 900; color: gold; margin-bottom: 20px; text-shadow: 0 0 20px rgba(255,215,0,0.8); }
        
    </style>
</head>
<body>

<div id="app-container">
    <!-- 1. Î°úÍ∑∏Ïù∏ ÌôîÎ©¥ -->
    <div id="login-screen">
        <div class="logo">CLASH<br>ROYALE</div>
        <!-- Google Login Button -->
        <button id="google-login-btn" class="btn btn-google">
            <span style="font-weight:bold; color:#4285F4">G</span> <span id="login-btn-text">Íµ¨Í∏Ä Í≥ÑÏ†ïÏúºÎ°ú Î°úÍ∑∏Ïù∏</span>
        </button>
        <div id="loading-msg" class="hidden">Ï≤òÎ¶¨ Ï§ë...</div>
    </div>

    <!-- 2. Ìôà ÌôîÎ©¥ -->
    <div id="home-screen" class="hidden">
        <div class="top-bar">
            <div class="profile-container">
                <div class="nickname-box" onclick="toggleDropdown()">
                    <span id="display-nickname" class="nickname-text">ÎãâÎÑ§ÏûÑ</span>
                    <div class="exp-bar"></div>
                </div>
                <!-- ÎìúÎ°≠Îã§Ïö¥ -->
                <div id="profile-dropdown" class="hidden">
                    <div class="dropdown-item text-white" onclick="changeName()">Ïù¥Î¶Ñ Î≥ÄÍ≤Ω</div>
                    <div class="dropdown-item text-red" onclick="logout()">Î°úÍ∑∏ÏïÑÏõÉ</div>
                </div>
            </div>
            
            <div class="trophy-display">
                <span>üèÜ</span> <span id="display-trophies">0</span>
            </div>
        </div>

        <div class="home-character">üëë</div>

        <div class="bottom-bar">
            <button id="battle-btn" class="btn btn-gold" onclick="startPvPMatchmaking()">Ï†ÑÌà¨ (PvP)</button>
        </div>
    </div>

    <!-- 3. Îß§Ïπ≠ ÌôîÎ©¥ (Ìôà ÌôîÎ©¥ ÏúÑÏóê Ïò§Î≤ÑÎ†àÏù¥) -->
    <div id="matching-screen" class="hidden">
        <div class="searching-text">ÎåÄÏ†Ñ ÏÉÅÎåÄ Ï∞æÎäî Ï§ë...</div>
        <button class="btn btn-red" onclick="cancelMatchmaking()">Ï∑®ÏÜå</button>
    </div>

    <!-- 4. Í≤åÏûÑ ÌôîÎ©¥ -->
    <div id="game-screen" class="hidden">
        <div id="arena" onclick="handleArenaClick(event)">
            <div class="river"></div>
            <div class="bridge left"></div>
            <div class="bridge right"></div>

            <!-- Ï†Å ÌÉÄÏõå -->
            <div class="tower enemy king-tower enemy-king" id="enemy-king">
                <div class="hp-bar-container">
                    <div class="hp-bar" style="width: 100%;"></div>
                    <span class="hp-text">4008</span>
                </div>
                ü§¥
            </div>
            <div class="tower enemy princess-tower enemy-princess left" id="enemy-left">
                <div class="hp-bar-container">
                    <div class="hp-bar" style="width: 100%;"></div>
                    <span class="hp-text">2534</span>
                </div>
                üë∏
            </div>
            <div class="tower enemy princess-tower enemy-princess right" id="enemy-right">
                <div class="hp-bar-container">
                    <div class="hp-bar" style="width: 100%;"></div>
                    <span class="hp-text">2534</span>
                </div>
                üë∏
            </div>

            <!-- ÏïÑÍµ∞ ÌÉÄÏõå -->
            <div class="tower my king-tower my-king" id="my-king">
                <div class="hp-bar-container">
                    <div class="hp-bar" style="width: 100%;"></div>
                    <span class="hp-text">4008</span>
                </div>
                ü§¥
            </div>
            <div class="tower my princess-tower my-princess left" id="my-left">
                <div class="hp-bar-container">
                    <div class="hp-bar" style="width: 100%;"></div>
                    <span class="hp-text">2534</span>
                </div>
                üë∏
            </div>
            <div class="tower my princess-tower my-princess right" id="my-right">
                <div class="hp-bar-container">
                    <div class="hp-bar" style="width: 100%;"></div>
                    <span class="hp-text">2534</span>
                </div>
                üë∏
            </div>
        </div>

        <!-- Í≤åÏûÑ UI -->
        <div id="game-ui">
            <div class="elixir-bar"><div class="elixir-fill" id="elixir-fill"></div></div>
            <div class="elixir-count" id="elixir-count">5</div>
            
            <div class="next-card">
                <div>Îã§Ïùå</div>
                <div class="next-card-icon" id="next-card-icon">‚ùì</div>
            </div>
            <div class="hand" id="card-hand">
                <!-- Ïπ¥ÎìúÎäî JSÎ°ú ÏÉùÏÑ± -->
            </div>
        </div>

        <!-- Í≤∞Í≥º Î™®Îã¨ -->
        <div id="result-modal">
            <div class="result-title" id="result-text">VICTORY!</div>
            <button class="btn btn-gold" onclick="returnToHome()">ÌôàÏúºÎ°ú</button>
        </div>
    </div>
</div>

<script type="module">
    // --- Firebase Initialization ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, GoogleAuthProvider, signInWithPopup, signInWithCustomToken, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, getDoc, collection, addDoc, onSnapshot, query, where, updateDoc, serverTimestamp, deleteDoc, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBS0Kr19gorGiYbJtqzvnMkPyxN77eAulA",
      authDomain: "fruitslayer-online.firebaseapp.com",
      projectId: "fruitslayer-online",
      storageBucket: "fruitslayer-online.firebasestorage.app",
      messagingSenderId: "396029026245",
      appId: "1:396029026245:web:164f80bdc02cef437bf5ac"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

    // Global State
    const STATE = {
        user: {
            nickname: null,
            trophies: 0,
            lastNameChange: 0
        },
        game: {
            id: null,
            role: null, // 'host' or 'guest'
            elixir: 5,
            cards: [],
            nextCard: null,
            hand: [],
            selectedCardIdx: -1,
            entities: [],
            towers: {},
            running: false,
            loopId: null,
            unsubscribeMoves: null
        },
        auth: {
            uid: null,
            isLoaded: false
        }
    };

    // --- Auth Logic ---
    const initAuth = async () => {
        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
             try {
                 await signInWithCustomToken(auth, __initial_auth_token);
             } catch (e) { console.warn("Custom token auth failed", e); }
        }
    };
    initAuth();

    onAuthStateChanged(auth, async (user) => {
        if (user) {
            STATE.auth.uid = user.uid;
            await checkUserProfile(user.uid);
        } else {
            STATE.auth.uid = null;
            showScreen('login');
            resetLoginUI();
        }
    });

    // Firestore Profile Check
    async function checkUserProfile(uid) {
        document.getElementById('loading-msg').classList.remove('hidden');
        document.getElementById('google-login-btn').classList.add('hidden');
        document.getElementById('loading-msg').innerText = "ÌîÑÎ°úÌïÑ ÌôïÏù∏ Ï§ë...";
        
        try {
            const userRef = doc(db, 'artifacts', appId, 'users', uid, 'profile', 'userData');
            const docSnap = await getDoc(userRef);

            if (docSnap.exists()) {
                STATE.user = docSnap.data();
                showScreen('home');
                updateHomeUI();
            } else {
                document.getElementById('loading-msg').classList.add('hidden');
                const btn = document.getElementById('google-login-btn');
                btn.classList.remove('hidden');
                document.getElementById('login-btn-text').innerText = "Ïã†Í∑ú Í≥ÑÏ†ï ÏÉùÏÑ±ÌïòÍ∏∞";
            }
        } catch (e) {
            console.error("Data load error", e);
            document.getElementById('loading-msg').innerText = "Ïò§Î•ò Î∞úÏÉù (ÏÉàÎ°úÍ≥†Ïπ®)";
            document.getElementById('google-login-btn').classList.remove('hidden');
        }
    }

    async function saveUserData() {
        if (!STATE.auth.uid) return;
        try {
            const userRef = doc(db, 'artifacts', appId, 'users', STATE.auth.uid, 'profile', 'userData');
            await setDoc(userRef, STATE.user);
        } catch (e) { console.error("Save failed", e); }
    }

    // --- UI Listeners ---
    window.handleLoginClick = async () => {
        if (STATE.auth.uid && !STATE.user.nickname) {
            let name = prompt("ÏÇ¨Ïö©Ìï† ÎãâÎÑ§ÏûÑÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî:");
            if (name && name.trim()) {
                STATE.user.nickname = name.trim();
                STATE.user.trophies = 0;
                STATE.user.lastNameChange = 0;
                await saveUserData();
                showScreen('home');
                updateHomeUI();
            }
            return;
        }
        if (STATE.auth.uid && STATE.user.nickname) {
            showScreen('home');
            updateHomeUI();
            return;
        }

        try {
            const provider = new GoogleAuthProvider();
            await signInWithPopup(auth, provider);
        } catch (error) {
            alert("Î°úÍ∑∏Ïù∏ Ïã§Ìå®: " + error.message);
        }
    };

    window.toggleDropdown = () => document.getElementById('profile-dropdown').classList.toggle('hidden');
    window.logout = () => signOut(auth);

    function resetLoginUI() {
        document.getElementById('google-login-btn').classList.remove('hidden');
        document.getElementById('login-btn-text').innerText = "Íµ¨Í∏Ä Í≥ÑÏ†ïÏúºÎ°ú Î°úÍ∑∏Ïù∏";
        document.getElementById('loading-msg').classList.add('hidden');
    }

    // --- PvP Matchmaking Logic ---
    let matchmakingListener = null;

    window.startPvPMatchmaking = async () => {
        document.getElementById('matching-screen').classList.remove('hidden');
        
        // 1. ÎåÄÍ∏∞ Ï§ëÏù∏ Í≤åÏûÑ Ï∞æÍ∏∞
        const gamesRef = collection(db, 'artifacts', appId, 'public', 'data', 'games');
        const q = query(gamesRef, where("status", "==", "waiting")); // Simple query Rule 2
        
        try {
            const querySnapshot = await getDocs(q);
            let joined = false;

            // Ïù¥ÎØ∏ ÎåÄÍ∏∞ Ï§ëÏù∏ Î∞©Ïù¥ ÏûàÏúºÎ©¥ Ï∞∏Í∞Ä
            for (const docSnap of querySnapshot.docs) {
                const gameData = docSnap.data();
                // ÎÇ¥Í∞Ä ÎßåÎì† Î∞©Ïù¥ ÏïÑÎãàÏñ¥Ïïº Ìï® (ÌòπÏãú Î™®Î•º Ï§ëÎ≥µ Î∞©ÏßÄ)
                if (gameData.player1.uid !== STATE.auth.uid) {
                    await updateDoc(doc(gamesRef, docSnap.id), {
                        player2: { uid: STATE.auth.uid, nickname: STATE.user.nickname },
                        status: 'playing',
                        startTime: serverTimestamp()
                    });
                    STATE.game.id = docSnap.id;
                    STATE.game.role = 'guest';
                    startGame(false); // Guest start
                    joined = true;
                    break;
                }
            }

            if (!joined) {
                // Î∞© ÏÉùÏÑ± (Host)
                const docRef = await addDoc(gamesRef, {
                    player1: { uid: STATE.auth.uid, nickname: STATE.user.nickname },
                    status: 'waiting',
                    createdAt: serverTimestamp()
                });
                STATE.game.id = docRef.id;
                STATE.game.role = 'host';
                
                // ÎÇ¥ Î∞©Ïóê ÎàÑÍ∞Ä Îì§Ïñ¥Ïò§ÎäîÏßÄ Í∞êÏãú
                matchmakingListener = onSnapshot(doc(gamesRef, docRef.id), (snap) => {
                    const data = snap.data();
                    if (data && data.status === 'playing') {
                        // ÏÉÅÎåÄÎ∞© ÏûÖÏû•!
                        if (matchmakingListener) matchmakingListener(); // Î¶¨Ïä§ÎÑà Ìï¥Ï†ú
                        startGame(true); // Host start
                    }
                });
            }

        } catch (e) {
            console.error("Matchmaking error", e);
            alert("Îß§Ïπ≠ Ï§ë Ïò§Î•ò Î∞úÏÉù");
            window.cancelMatchmaking();
        }
    };

    window.cancelMatchmaking = async () => {
        if (matchmakingListener) matchmakingListener();
        
        // ÎÇ¥Í∞Ä ÎßåÎì† ÎåÄÍ∏∞ Î∞©Ïù¥ ÏûàÎã§Î©¥ ÏÇ≠Ï†ú
        if (STATE.game.role === 'host' && STATE.game.id) {
            try {
                await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'games', STATE.game.id));
            } catch(e) {}
        }
        
        document.getElementById('matching-screen').classList.add('hidden');
        STATE.game.id = null;
    };

    // --- Game Logic ---
    const CARD_DATA = [
        { id: 'giant', name: 'ÏûêÏù¥Ïñ∏Ìä∏', icon: 'üëπ', cost: 5, type: 'ground', target: 'building', speed: 1.5, hp: 1000, dmg: 50, range: 2 },
        { id: 'pekkamini', name: 'ÎØ∏Îãà ÌéòÏπ¥', icon: 'ü§ñ', cost: 4, type: 'ground', target: 'all', speed: 3, hp: 600, dmg: 150, range: 2 },
        { id: 'knight', name: 'Í∏∞ÏÇ¨', icon: '‚öîÔ∏è', cost: 3, type: 'ground', target: 'all', speed: 2, hp: 800, dmg: 40, range: 2 },
        { id: 'archers', name: 'ÏïÑÏ≤ò', icon: 'üèπ', cost: 3, type: 'ground', target: 'all', speed: 2, hp: 300, dmg: 30, range: 5, count: 2 },
        { id: 'cannon', name: 'ÎåÄÌè¨', icon: 'üí£', cost: 3, type: 'building', target: 'ground', hp: 500, dmg: 40, range: 6, lifetime: 30 },
        { id: 'baby_dragon', name: 'Î≤†Ïù¥ÎπÑ ÎìúÎûòÍ≥§', icon: 'üêâ', cost: 4, type: 'air', target: 'all', speed: 2.5, hp: 700, dmg: 40, range: 3 },
        { id: 'fireball', name: 'ÌååÏù¥Ïñ¥ Î≥º', icon: 'üî•', cost: 4, type: 'spell', dmg: 200, radius: 3 },
        { id: 'skeletons', name: 'Ìï¥Í≥® Î≥ëÏÇ¨', icon: 'üíÄ', cost: 1, type: 'ground', target: 'all', speed: 2.5, hp: 50, dmg: 20, range: 1, count: 3 }
    ];
    
    // ÌÉÄÏõå Ïä§ÌÉØ
    const TOWER_STATS = {
        princess: { hp: 2534, dmg: 80, range: 7, speed: 0.8 },
        king: { hp: 4008, dmg: 90, range: 7, speed: 1 }
    };

    function showScreen(name) {
        ['login-screen', 'home-screen', 'matching-screen', 'game-screen'].forEach(id => {
            document.getElementById(id).classList.add('hidden');
        });
        document.getElementById(name + '-screen').classList.remove('hidden');
    }

    function updateHomeUI() {
        document.getElementById('display-nickname').innerText = STATE.user.nickname;
        document.getElementById('display-trophies').innerText = STATE.user.trophies;
        document.getElementById('profile-dropdown').classList.add('hidden');
    }

    // --- In-Game ---
    function startGame(isHost) {
        showScreen('game');
        document.getElementById('result-modal').style.display = 'none';

        STATE.game.elixir = 5;
        STATE.game.entities = [];
        STATE.game.running = true;

        let deck = [...CARD_DATA].sort(() => Math.random() - 0.5);
        STATE.game.hand = deck.slice(0, 4);
        STATE.game.nextCard = deck[4];
        
        // ÌÉÄÏõå Ï¥àÍ∏∞Ìôî
        const towers = {
            'my-king': { max: TOWER_STATS.king.hp, hp: TOWER_STATS.king.hp, el: document.getElementById('my-king'), team: 'my' },
            'my-left': { max: TOWER_STATS.princess.hp, hp: TOWER_STATS.princess.hp, el: document.getElementById('my-left'), team: 'my' },
            'my-right': { max: TOWER_STATS.princess.hp, hp: TOWER_STATS.princess.hp, el: document.getElementById('my-right'), team: 'my' },
            'enemy-king': { max: TOWER_STATS.king.hp, hp: TOWER_STATS.king.hp, el: document.getElementById('enemy-king'), team: 'enemy' },
            'enemy-left': { max: TOWER_STATS.princess.hp, hp: TOWER_STATS.princess.hp, el: document.getElementById('enemy-left'), team: 'enemy' },
            'enemy-right': { max: TOWER_STATS.princess.hp, hp: TOWER_STATS.princess.hp, el: document.getElementById('enemy-right'), team: 'enemy' }
        };
        STATE.game.towers = towers;

        for (let k in towers) updateTowerHP(k);
        
        // Îßµ Ï†ïÎ¶¨
        document.querySelectorAll('.unit').forEach(e => e.remove());
        document.querySelectorAll('.projectile').forEach(e => e.remove());

        renderHand();
        startGameLoop();

        // ÏÉÅÎåÄÎ∞© ÏõÄÏßÅÏûÑ Í∞êÏßÄ (Firestore Listener)
        const movesRef = collection(db, 'artifacts', appId, 'public', 'data', 'games', STATE.game.id, 'moves');
        STATE.game.unsubscribeMoves = onSnapshot(movesRef, (snapshot) => {
            snapshot.docChanges().forEach((change) => {
                if (change.type === "added") {
                    const move = change.doc.data();
                    // ÎÇ¥ ÏõÄÏßÅÏûÑÏùÄ Î¨¥Ïãú (Ïù¥ÎØ∏ Î°úÏª¨ÏóêÏÑú Ï≤òÎ¶¨Ìï®)
                    if (move.uid !== STATE.auth.uid) {
                        spawnEnemyFromNetwork(move);
                    }
                }
            });
        });
    }

    // ÏÉÅÎåÄÎ∞©Ïù¥ Ïú†ÎãõÏùÑ ÏÜåÌôòÌñàÏùÑ Îïå (Ï¢åÌëú ÎåÄÏπ≠ Î≥ÄÌôò Ï§ëÏöî)
    function spawnEnemyFromNetwork(move) {
        const cardData = CARD_DATA.find(c => c.id === move.cardId);
        if (!cardData) return;

        const arenaRect = document.getElementById('arena').getBoundingClientRect();
        
        // ÏÉÅÎåÄÍ∞Ä Î≥¥ÎÇ∏ Ï¢åÌëú (0~100%)
        // ÏÉÅÎåÄÎäî ÏûêÏã†Ïùò ÏïÑÎûòÏ™Ω(100%)ÏóêÏÑú ÏÜåÌôòÌñàÍ≤†ÏßÄÎßå, ÎÇòÏóêÍ≤åÎäî ÏúÑÏ™Ω(0%)Ïù¥ ÎêòÏñ¥Ïïº Ìï®
        // XÏ∂ï: ÏÉÅÎåÄÏùò ÏôºÏ™Ω -> ÎÇòÏùò Ïò§Î•∏Ï™Ω (Mirror X) or Í∑∏ÎåÄÎ°ú?
        // ÌÅ¥ÎûòÏãú Î°úÏñÑÏùÄ Î≥¥ÎìúÍ∞Ä 180ÎèÑ ÌöåÏ†ÑÎêú ÌòïÌÉú.
        // ÏÉÅÎåÄÍ∞Ä (20%, 90%)Ïóê ÏÜåÌôò -> ÎÇòÏóêÍ≤åÎäî (80%, 10%)Ïóê Î≥¥Ïó¨Ïïº Ìï®.
        
        const renderX = (1 - move.rx) * arenaRect.width;
        const renderY = (1 - move.ry) * arenaRect.height;

        spawnUnit(cardData, renderX, renderY, 'enemy', false); // false = don't send to network
    }

    function updateTowerHP(id) {
        const t = STATE.game.towers[id];
        if (t.hp < 0) t.hp = 0;
        const pct = (t.hp / t.max) * 100;
        const bar = t.el.querySelector('.hp-bar');
        const txt = t.el.querySelector('.hp-text');
        
        bar.style.width = `${pct}%`;
        txt.innerText = Math.floor(t.hp);
        
        if (t.hp <= 0) t.el.style.opacity = 0.5;
        else t.el.style.opacity = 1;
    }

    function renderHand() {
        const handEl = document.getElementById('card-hand');
        handEl.innerHTML = '';
        STATE.game.hand.forEach((card, idx) => {
            const el = document.createElement('div');
            el.className = 'card';
            if (STATE.game.elixir < card.cost) el.classList.add('disabled');
            if (STATE.game.selectedCardIdx === idx) el.classList.add('selected');
            el.innerHTML = `<div class="card-cost">${card.cost}</div><div class="card-img">${card.icon}</div><div>${card.name}</div>`;
            el.onclick = () => selectCard(idx);
            handEl.appendChild(el);
        });
        document.getElementById('next-card-icon').innerText = STATE.game.nextCard.icon;
        updateElixirUI();
    }

    function selectCard(idx) {
        if (STATE.game.elixir < STATE.game.hand[idx].cost) return;
        STATE.game.selectedCardIdx = (STATE.game.selectedCardIdx === idx) ? -1 : idx;
        renderHand();
    }

    window.handleArenaClick = async (e) => {
        if (STATE.game.selectedCardIdx === -1) return;
        
        const rect = document.getElementById('arena').getBoundingClientRect();
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;
        
        // ÎÇ¥ ÏßÑÏòÅ(ÏïÑÎûòÏ™Ω)Îßå ÏÜåÌôò Í∞ÄÎä• (Í∞ÑÎã®ÌïòÍ≤å Ï†àÎ∞ò)
        if (y < rect.height * 0.4 && STATE.game.hand[STATE.game.selectedCardIdx].type !== 'spell') {
            return; // Cannot spawn in enemy territory
        }

        const card = STATE.game.hand[STATE.game.selectedCardIdx];
        
        // 1. Î°úÏª¨ ÏÜåÌôò
        spawnUnit(card, x, y, 'my', true);

        // 2. ÏûêÏõê ÏÜåÎ™® Î∞è Îç± ÏàúÌôò
        STATE.game.elixir -= card.cost;
        STATE.game.hand[STATE.game.selectedCardIdx] = STATE.game.nextCard;
        STATE.game.nextCard = card; // Îã®Ïàú ÏàúÌôò
        STATE.game.selectedCardIdx = -1;
        renderHand();

        // 3. ÎÑ§Ìä∏ÏõåÌÅ¨ Ï†ÑÏÜ° (ÎπÑÏú® Ï¢åÌëú ÏÇ¨Ïö©)
        const rx = x / rect.width;
        const ry = y / rect.height;
        
        try {
            const movesRef = collection(db, 'artifacts', appId, 'public', 'data', 'games', STATE.game.id, 'moves');
            await addDoc(movesRef, {
                uid: STATE.auth.uid,
                cardId: card.id,
                rx: rx,
                ry: ry,
                timestamp: serverTimestamp()
            });
        } catch(err) { console.error("Move send error", err); }
    };

    function spawnUnit(cardData, x, y, team, isLocal) {
        const div = document.createElement('div');
        div.className = `unit ${team}`;
        div.innerText = cardData.icon;
        div.style.left = x + 'px';
        div.style.top = y + 'px';
        div.innerHTML += `<div class="unit-hp"><div class="unit-hp-fill"></div></div>`;
        document.getElementById('arena').appendChild(div);

        const entity = {
            el: div,
            x: x, y: y,
            data: cardData,
            hp: cardData.hp, maxHp: cardData.hp,
            team: team,
            lastAttack: 0,
            dead: false
        };

        if (cardData.type === 'spell') {
            setTimeout(() => {
                applySpellDamage(entity);
                div.remove();
            }, 500);
        } else {
            STATE.game.entities.push(entity);
        }
    }

    function applySpellDamage(spell) {
        // Í∞ÑÎã®Ìïú Î≤îÏúÑ Îç∞ÎØ∏ÏßÄ (ÌÉÄÏõå Ìè¨Ìï®)
        const targetTeam = spell.team === 'my' ? 'enemy' : 'my';
        const range = 100; // Pixel range
        
        // Ïú†Îãõ
        STATE.game.entities.forEach(ent => {
            if (ent.team === targetTeam && Math.hypot(ent.x - spell.x, ent.y - spell.y) < range) {
                takeDamage(ent, spell.data.dmg);
            }
        });

        // ÌÉÄÏõå
        for (let k in STATE.game.towers) {
            const t = STATE.game.towers[k];
            if (t.team === targetTeam) {
                const rect = t.el.getBoundingClientRect();
                const arenaRect = document.getElementById('arena').getBoundingClientRect();
                const tx = rect.left - arenaRect.left + rect.width/2;
                const ty = rect.top - arenaRect.top + rect.height/2;
                if (Math.hypot(tx - spell.x, ty - spell.y) < range) {
                    takeDamage(t, spell.data.dmg);
                }
            }
        }
    }

    function startGameLoop() {
        if (STATE.game.loopId) clearInterval(STATE.game.loopId);
        
        let lastTime = Date.now();
        let elixirTimer = 0;

        STATE.game.loopId = setInterval(() => {
            if (!STATE.game.running) return;
            const now = Date.now();
            const dt = (now - lastTime) / 1000;
            lastTime = now;

            // ÏóòÎ¶≠ÏÑú (2.8Ï¥àÎãπ 1)
            elixirTimer += dt;
            if (elixirTimer >= 2.8) {
                if (STATE.game.elixir < 10) {
                    STATE.game.elixir++;
                    renderHand();
                }
                elixirTimer = 0;
            }
            updateElixirUI(elixirTimer/2.8);

            updateEntities(now);
            checkWinCondition();
        }, 50);
    }

    function updateElixirUI(pct) {
        const w = (STATE.game.elixir + pct) * 10;
        document.getElementById('elixir-fill').style.width = `${Math.min(w, 100)}%`;
        document.getElementById('elixir-count').innerText = STATE.game.elixir;
    }

    function updateEntities(now) {
        STATE.game.entities.forEach(ent => {
            if (ent.dead) return;
            const targetTeam = ent.team === 'my' ? 'enemy' : 'my';
            const target = findNearest(ent, targetTeam);

            if (target) {
                const range = ent.data.range * 30; // Scale range
                if (target.dist <= range) {
                    // Attack
                    if (now - ent.lastAttack > 1200) { // 1.2s attack speed
                        createProjectile(ent, target.obj);
                        takeDamage(target.obj, ent.data.dmg);
                        ent.lastAttack = now;
                        // recoil effect
                        ent.el.style.transform = `translate(-50%, -50%) scale(1.2)`;
                        setTimeout(() => ent.el.style.transform = `translate(-50%, -50%) scale(1)`, 100);
                    }
                } else {
                    // Move
                    const dx = target.x - ent.x;
                    const dy = target.y - ent.y;
                    const angle = Math.atan2(dy, dx);
                    const speed = ent.data.speed * 1.5;
                    ent.x += Math.cos(angle) * speed;
                    ent.y += Math.sin(angle) * speed;
                    ent.el.style.left = ent.x + 'px';
                    ent.el.style.top = ent.y + 'px';
                }
            }
        });
        STATE.game.entities = STATE.game.entities.filter(e => !e.dead);
    }

    function findNearest(me, team) {
        let nearest = null;
        let minDist = Infinity;
        
        // 1. Units
        if (me.data.target === 'all') {
            STATE.game.entities.forEach(other => {
                if (other.team === team && !other.dead) {
                    const d = Math.hypot(me.x - other.x, me.y - other.y);
                    if (d < minDist) {
                        minDist = d;
                        nearest = { obj: other, x: other.x, y: other.y, dist: d };
                    }
                }
            });
        }
        
        // 2. Towers
        for (let k in STATE.game.towers) {
            const t = STATE.game.towers[k];
            if (t.team === team && t.hp > 0) {
                const rect = t.el.getBoundingClientRect();
                const arenaRect = document.getElementById('arena').getBoundingClientRect();
                const tx = rect.left - arenaRect.left + rect.width/2;
                const ty = rect.top - arenaRect.top + rect.height/2;
                const d = Math.hypot(me.x - tx, me.y - ty);
                if (d < minDist) {
                    minDist = d;
                    nearest = { obj: t, x: tx, y: ty, dist: d };
                }
            }
        }
        return nearest;
    }

    function takeDamage(obj, dmg) {
        obj.hp -= dmg;
        if (obj.el.classList.contains('tower')) {
            // ÌÉÄÏõå ÌîºÍ≤© Ìö®Í≥º
            obj.el.style.filter = 'brightness(2) sepia(1) hue-rotate(-50deg)';
            setTimeout(() => obj.el.style.filter = 'drop-shadow(0 5px 5px rgba(0,0,0,0.6))', 100);
            
            // Tower Key Ï∞æÍ∏∞
            for(let k in STATE.game.towers) {
                if (STATE.game.towers[k] === obj) {
                    updateTowerHP(k);
                    break;
                }
            }
        } else {
            // Ïú†Îãõ Îç∞ÎØ∏ÏßÄ
            const pct = (obj.hp / obj.maxHp) * 100;
            obj.el.querySelector('.unit-hp-fill').style.width = `${Math.max(0, pct)}%`;
            if (obj.hp <= 0) {
                obj.dead = true;
                obj.el.remove();
            }
        }
    }

    function createProjectile(from, to) {
        let tx, ty;
        if (to.el.classList.contains('tower')) {
            const r = to.el.getBoundingClientRect();
            const ar = document.getElementById('arena').getBoundingClientRect();
            tx = r.left - ar.left + r.width/2;
            ty = r.top - ar.top + r.height/2;
        } else {
            tx = to.x; ty = to.y;
        }
        
        const p = document.createElement('div');
        p.className = 'projectile';
        p.style.left = from.x + 'px';
        p.style.top = from.y + 'px';
        document.getElementById('arena').appendChild(p);
        
        p.animate([
            { left: from.x + 'px', top: from.y + 'px' },
            { left: tx + 'px', top: ty + 'px' }
        ], { duration: 200, easing: 'linear' }).onfinish = () => p.remove();
    }

    function checkWinCondition() {
        if (STATE.game.towers['enemy-king'].hp <= 0) endGame(true);
        else if (STATE.game.towers['my-king'].hp <= 0) endGame(false);
    }

    async function endGame(win) {
        STATE.game.running = false;
        clearInterval(STATE.game.loopId);
        if (STATE.game.unsubscribeMoves) STATE.game.unsubscribeMoves();

        const modal = document.getElementById('result-modal');
        const text = document.getElementById('result-text');
        modal.style.display = 'flex';

        if (win) {
            text.innerText = "VICTORY!";
            text.style.color = "gold";
            STATE.user.trophies += 30;
        } else {
            text.innerText = "DEFEAT";
            text.style.color = "#e74c3c";
            STATE.user.trophies = Math.max(0, STATE.user.trophies - 20);
        }
        await saveUserData();
        
        // Í≤åÏûÑ Ï¢ÖÎ£å Ï≤òÎ¶¨ (Î∞© Ï†ïÎ¶¨ Îì±)
        if (STATE.game.id && STATE.game.role === 'host') {
            try { await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'games', STATE.game.id)); } catch(e){}
        }
    }

    window.returnToHome = () => {
        showScreen('home');
        updateHomeUI();
    };

    // Auto-bind
    document.getElementById('google-login-btn').addEventListener('click', window.handleLoginClick);
</script>

</body>
</html>
